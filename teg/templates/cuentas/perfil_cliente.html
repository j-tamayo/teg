{% extends "base.html" %}

{% block main_content %}
{% include 'cuentas/modales_usuario.html' %}
{% csrf_token %}
<header class="header" style="margin-top: 3%; margin-bottom: 2%;">
	<div class="row">
		<div class="col-xs-7 text-success">
			<h1>Bienvenido {{ usuario.get_full_name }}</h1>
		</div>
		<div class="col-xs-5 pull-right">
			<img src="../../static/img_generic/car-icon.png" class="img-rounded" style="width: 40%; margin-left:50%">
		</div>
	</div>
</header>

<div class="container-fluid">
	<div role="tabpanel">
		<ul class="nav nav-tabs nav-justified">
			<li role="presentation" class="active"><a href="#Perfil" role="tab" data-toggle="tab">Ver Perfil</a></li>
			<li role="presentation"><a href="#Solicitudes" role="tab" data-toggle="tab">Solicitudes</a></li>
			<li role="presentation"><a href="#Notificaciones" role="tab" data-toggle="tab">Notificaciones</a></li>
			<li role="presentation">
				<a class="dropdown-toggle" data-toggle="dropdown" href="#Opciones" role="button" aria-expanded="false">Opciones<span class="caret"></span></a>
			    <ul class="dropdown-menu" role="menu">
					<li><a href="#">Opci&oacute;n1</a></li>
		            <li><a href="#">Opci&oacute;n2</a></li>
		            <li><a href="#">Opci&oacute;n3</a></li>
		            <li class="divider"></li>
		            <li><a href="#">Opci&oacute;n4</a></li>
		            <li class="divider"></li>
		            <li><a href="{% url 'cuentas_logout' %}">Salir</a></li>
			    </ul>
			</li>
		</ul>

		<div class="tab-content" style="margin-top: 3%;">
		    <div role="tabpanel" class="tab-pane active" id="Perfil">
		    	<div class="row">
					<div class="col-xs-5 col-xs-offset-1">
						<h3 class="text-success">Informaci&oacute;n del usuario</h3>
						<br>
						<p>Nombre: {{ usuario.nombres }}</p>
						<p>Apellido: {{ usuario.apellidos }}</p>
						<p>C&eacute;dula: {{ usuario.cedula }}</p>
						<p>Estado: {{ usuario.municipio.estado }}</p>
						<p>Municipio: {{ usuario.municipio }}</p>
						<p>Dirección: {{ usuario.direccion }}</p>
						<p>Correo: {{ usuario.correo }}</p>		
					</div>
					<div class="col-xs-1">
						<div style="border-left:1px solid #000;height:500px"></div>
					</div>
					<div class="col-xs-5">
						{% if poliza %}
							<h3 class="text-success">P&oacute;liza asociada</h3>
							<br>
							<p>N&uacute;mero: "N&uacute;mero P&oacute;liza"</p>
							<p>Fecha Vencimiento: "dd/mm/aaaa"</p>
							<p>Tipo de P&oacute;liza: "Tipo X"</p>
							<p>Descripci&oacute;n: "Descripci&oacute;n P&oacute;liza"</p>
						{% else %}
							<h3 class="text-success">El usuario no posee póliza asociada</h3>
						{% endif %}
					</div>  
		    	</div>
		    </div>

		    <div role="tabpanel" class="tab-pane" id="Solicitudes">

		    	<div class="row">
					<div class="col-xs-3 col-xs-offset-1">
		    			<h3 class="text-success">Solicitudes Enviadas</h3>
		    		</div>
		    		<div class="col-xs-5 col-xs-offset-3">
		    			<br>
						<a class="btn btn-danger" data-toggle="modal" data-target="#Reclamo">Presentar Reclamo</a>
						<a class="btn btn-primary" id="crear_solicitud">Crear Solicitud</a>
						<a class="btn btn-success" data-toggle="modal" data-target="#Buscar">Buscar</a>
		    		</div>
		    	</div>
		    	<div id="contenedor_solicitudes">
			    	<div class="row">
			    		<br>
						<div class="col-xs-10 col-xs-offset-1">
							{% if solicitudes %}
			    			<table class="table table-bordered text-center">
			    				<thead>
									<tr>
									 	<th class="text-center">Tipo Solicitud</th>
										<th class="text-center">N&uacute;mero de Orden</th>
										<th class="text-center">Estatus</th>
										<th class="text-center">Fecha de atenci&oacute;n</th>
										<th class="text-center">Opciones</th>
									</tr>
								</thead>
								<tbody id="solicitudes_table_body">
									{% for s in solicitudes %}
									<tr>
										<td>{{s.tipo_inspeccion}}</td>
										<td>{{s.numero_orden.codigo}}</td>
										<td>{{s.estatus}}</td>
										<td>{{s.numero_orden.fecha_atencion}}</td>
										<td>
											<a href="#" class="btn btn-danger btn-sm eliminar-solicitud" solicitud-id="{{s.pk}}"><i class="fa fa-times"></i></a>
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
							{% else %}
							<h4>No hay solicitudes</h4>
							{% endif %}
			    		</div>
			    	</div>
		    	</div>

				<div id="contenedor_crear_solicitud" style="display:none">
					<div id="spinner_form">
						{% load staticfiles %}
						<center>
					    	<img src="{% static "img/ajax-loader.gif" %}" alt="Cargando Formulario..."/>
					    </center>
					</div>
					<div id="contenido" class="row"></div>
				</div>

		    </div>

		    <div role="tabpanel" class="tab-pane" id="Notificaciones">
		    	<div class="row">
					<div class="col-xs-5 col-xs-offset-1">
		    			<h3 class="text-success">Notificaciones Recibidas</h3>
		    		</div>
		    		<div class="col-xs-2 col-xs-offset-4">
		    			<br>
						<a class="btn btn-success" data-toggle="modal" data-target="#Buscar">Buscar</a>
		    		</div>
		    	</div>
		    	<div id="contenedor_notidicacion_encuesta"  class="row">
		    		<br>
					<div class="col-xs-10 col-xs-offset-1">
		    			{% if notificaciones %}
		    			<table class="table table-bordered">
		    				<thead>
								<tr>
								 	<th style="width:40%">Asunto</th>
									<th style="width:30%">Tipo notificaci&oacute;n</th>
									<th style="width:15%">Fecha recibida</th>
									<th style="width:5%">Estado</th>
									<th style="width:10%">Opciones</th>
								</tr>
							</thead>
							<tbody id="solicitudes_table_body">
								{% for n in notificaciones %}
								<tr id="notificacion_{{n.id}}">
									<td>{{n.notificacion.asunto}}</td>
									<td>{{n.notificacion.tipo_notificacion.descripcion}}</td>
									<td>{{ n.fecha_creacion }}</td>
									<td>
										<span id="marca_{{n.id}}" class="label {% if n.leida %} label-info {% else %} label-warning {% endif %}">{% if n.leida %} Leida {% else %} Nueva {% endif %}</span>
									</td>
									<td>
										<a class="btn btn-primary btn-sm abrir_notificacion" target="{{n.id}}" role="button" title="Abrir Notificaci&oacute;n">
											<i class="fa fa-eye"></i>
										</a>
										<a class="btn btn-danger btn-sm" role="button" target="{{n.id}}" title="Borrar Notificaci&oacute;n">
											<i class="fa fa-trash"></i>
										</a>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
						{% else %}
						<h4>No posee notificaciones</h4>
						{% endif %}
		    		</div>
		    	</div>
		    	<div id="notificacion_encuesta_contenido" class="row" style="display:none">
		    		<div class="col-xs-10 col-xs-offset-1">
						<br>
						<div class="panel panel-dashboard-gray">
							<div class="panel-heading">
								<div class="row">
									<div id="titulo_notificacion_encuesta" class="col-xs-8">
										
									</div>
									<div class="col-xs-4">
										<a id="cerrar_notificacion" class="btn btn-default pull-right" role="button" title="Cerrar Notificaci&oacute;n"><i class="fa fa-times"></i></a>
									</div>
								</div>
							</div>
							<div id="contenido_notificacion_encuesta" class="panel-body">
								
							</div>
						</div>
					</div>
		    	</div>
		    </div>
	  	</div>
	 </div>
</div>

{% endblock %}

{% block javascripts %}
	{{ block.super }}

	<script type="application/javascript">

		$(function(){
			/********** PARA CARGAR LA INTERFAZ DE LA CREACIÓN DE SOLICITUD *************/
			$(document).on('click', '#crear_solicitud', function(){
				$('#contenedor_solicitudes').hide();
				$('#contenedor_crear_solicitud').show();
				$.ajax({
					method: 'GET',
					url: '{% url "crear_solicitud" %}',
					data:{
						'estado': {{usuario.municipio.estado.id}}
					},
					dataType: 'html',
					complete: function(){
					  $('#spinner_form').hide();
					  $('#crear_solicitud').html('Ver Solicitudes');
					  $('#crear_solicitud').attr('id','ver_solicitudes');
					}
				})
				.done(function(data){
					$('#contenido').html(data);
					$('#fecha_asistencia').datepicker({
					  autoclose: true,
					  clearBtn: true,
					  language: "es",
					  startView: 1,
					  daysOfWeekDisabled: [0,6],
					  datesDisabled:[]
					});
					$('#fecha_asistencia').datepicker('setDate', new Date());
					$('#fecha_asistencia').datepicker('update');
					$('#crear_solicitud_form').validator();
				})

			});
			/********** FIN *************/

			$(document).on('click', '#ver_solicitudes', function(){
				$('#contenedor_solicitudes').show();
				$('#contenedor_crear_solicitud').hide();
				$('#ver_solicitudes').html('Crear Solicitud');
				$('#ver_solicitudes').attr('id','crear_solicitud');
			});

			function cargar_centros(filtro, valor){
				data_object = {}

				if(filtro==='municipio'){
					data_object['municipio_id'] = valor;
				}
				else if(filtro==='estado'){
					data_object['estado_id'] = valor;
				}

				// Llamada AJAX para obtener los centros de inspección
				$.ajax({
					method: 'GET',
					url: '/sgt/obtener-centros',
					data: data_object,
					dataType: "json"
				})
				.done(function(data){
					if(!data.hasOwnProperty('error_msg')){
						// Se reinicia los centros de inspeccion
						$('#tabla_centros_insp > tbody').html('');
						$.each(data, function(key, value){
							$('#tabla_centros_insp > tbody').append('<tr id="'+value.pk+'">\
								<td>'+value.nombre+'</td>\
								<td>'+value.direccion+'</td>\
								<td>'+value.disponibilidad+'\
									<span class="label label-'+value.etiqueta_clase+'">'+value.etiqueta+'</span>\
								</td>\
								<td><input name="centro_inspeccion" value="'+value.pk+'" type="radio" required="" data-error="Este campo es obligatorio"></td>\
								</tr>');
						});
					}
					else{
						console.lg('Error');
					}
				});
			}

			/********** PARA CARGAR LOS MUNICIPIOS POR ESTADO EN EL FORMULARIO DE CREACION DE SOLICITUD *************/
			$(document).on('change', '#select_solicitud_estado', function(){
				value = $(this).val();
				
				if(value.length > 0){
					// LLamada AJAX para obtener los municipios
					$.ajax({
						method: 'GET',
						url: '/sgt/obtener-municipios/'+value,
						data:{
							'con_centro': true
						},
						dataType: "json"
					})
					.done(function(data){
						if(!data.hasOwnProperty('error_msg')){
							// Se reinicia el Select de municipios
							$('#select_solicitud_municipio').html('<option value="">---------</option>');
							
							$.each(data, function(key, value){
								$('#select_solicitud_municipio').append('<option value="'+value.pk+'">'+value.fields.nombre+'</option>');
							});
						}
						else{
							console.lg('Error');
						}
					});
					// Llamada a la función para obtener los centros por estado
					cargar_centros('estado', value);
				}
			});
			/********** FIN *************/

			/********** PARA CARGAR LOS CENTROS DE INSPECCION POR MUNICIPIO EN EL FORMULARIO DE CREACION DE SOLICITUD *************/
			//$('#select_solicitud_municipio').change(function(){
			$(document).on('change', '#select_solicitud_municipio', function(){
				value = $(this).val();
				if(value.length > 0){
					// Llamada a la función para obtener los centros por estado
					cargar_centros('municipio', value);
				}
			});
			
			/********** CARGAR MODAL DE CONFIRMACION DE TICKET *************/
			$(document).on('click', '#mostrar_ticket', function(event){
				event.preventDefault();

				tipo_solicitud = $('#id_tipo_solicitud').val();
				fecha_asistencia = $('#id_fecha_asistencia').val();
				value = $('input[name="centro_inspeccion"]:checked');

				if(value.length > 0 && tipo_solicitud.length > 0 && fecha_asistencia.length > 0){
					value = value.val();
					// Llamada AJAX para obtener los centros de inspección
					$.ajax({
						method: 'GET',
						url: '/sgt/obtener-numero/'+value,
						dataType: 'json',
						data:{
							fecha_asistencia: fecha_asistencia
						}
					})
					.done(function(data){
						if(!data.hasOwnProperty('error_msg')){
							$('#t_nombre_centro').html('<p>'+data[0].nombre+'</p>');
							$('#t_fecha_asistencia').html('<p>'+fecha_asistencia+'</p>');
							$('#t_estado_centro').html('<p>'+data[0].estado+'</p>');
							$('#t_municipio_centro').html('<p>'+data[0].municipio+'</p>');
							//$('#t_numero_orden').html('<p>'++'</p>');
							$('#t_hora_asistencia').html('<select id="hora_asistencia_ticket" class="form-control" name="hora_asistencia"></select>');
							$.each(data[0].horarios, function(key,val){
								$('#t_hora_asistencia>select').append(
									'<option value="'+val.value+'">'+val.text+'</option>');
							});
							$('#Ticket').modal('show'); 
						}
						else{
							console.lg('Error');
						}
					});
				}
			});
			/********** FIN *************/

			/********* MOSTRAR MODAL DE CONFIRMACIÓN PARA GENERAR TICKET **********/
			$(document).on('click','#generar_ticket', function(){
				centro_id = $('input[name="centro_inspeccion"]:checked').val();
				centro = $('#centro_'+centro_id).text();
				fecha = $('#id_fecha_asistencia').val();
				hora = $('#hora_asistencia_ticket option:selected').text();

				$('#btn_close_modal_generic').remove();
				$('#title_modal_generic').html('Confirmación');
				$('#body_modal_generic').html(
					'<div class="row">\
						<div class="col-xs-12"><h4>¿Está seguro que desea generar el siguiente ticket?</h4></div>\
					</div><br>\
					<div class="row">\
						<div class="col-xs-12">\
							<div class="col-xs-4">'+centro+'</div>\
							<div class="col-xs-4">'+fecha+'</div>\
							<div class="col-xs-4">'+hora+'</div>\
						</div>\
					</div><br>'
				);
				$('#footer_modal_generic').html(
					'<div class="col-xs-3 col-xs-offset-3">\
						<a id="cancelar_ticket" href="#" class="btn btn-danger col-xs-12">Cancelar</a>\
					</div>\
					<div class="col-xs-3">\
						<a id="confirmar_ticket" href="#" class="btn btn-primary col-xs-12">Aceptar</a>\
					</div>'
				);
				$('#Ticket').modal('hide');
				$('#modal_generic').modal({
					backdrop: 'static',
					keyboard: false
				});
			});

			$(document).on('click','#cancelar_ticket',function(){
				$('#modal_generic').modal('hide');
				$('#Ticket').modal('show');
			});
			/********* FIN **********/

			/********** CREAR TICKET *************/
			$(document).on('click','#confirmar_ticket',function(){
				centro = $('input[name="centro_inspeccion"]:checked').val();
				fecha = $('#id_fecha_asistencia').val();
				hora = $('#hora_asistencia_ticket').val();
				tipo_solicitud = $('#id_tipo_solicitud').val();

				// Llamada AJAX para generar el ticket
				$.ajax({
					method:'POST',
					url:'{% url "crear_solicitud" %}',
					dataType:'json',
					data:{
						centro: centro,
						fecha_asistencia: fecha,
						hora_asistencia: hora,
						tipo_inspeccion: tipo_solicitud,
						csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value
					}
				})
				.done(function(data){
					if(data.resultado == 0){
						$('#solicitudes_table_body').prepend(
							'<tr>\
								<td>'+data.solicitud.tipo_solicitud+'</td>\
								<td>'+data.solicitud.numero_orden+'</td>\
								<td>'+data.solicitud.estatus+'</td>\
								<td>...</td>\
							</tr>'
						);
						$('#contenedor_crear_solicitud').hide();
						$('#contenedor_solicitudes').show();
						$('#ver_solicitudes').html('Crear Solicitud');
						$('#ver_solicitudes').attr('id','crear_solicitud');

						$('#modal_generic').modal('hide');
					}
				})
				.fail(function(){
					console.log('error');
				});
			});
			/********** FIN *************/

			/********** ABRIR NOTIFICACIÓN *************/

			$(document).on('click','.abrir_notificacion',function(){
				notificacion_usuario_id = $(this).attr('target');
				$.ajax({
					method: 'GET',
					url: '{% url "consultar_notificacion" %}',
					dataType: 'json',
					data: {
						'notificacion_usuario_id': notificacion_usuario_id
					},
					success:function(data){
						console.log(data);
						marca_id = '#marca_' + notificacion_usuario_id;
						marca = $(marca_id).text().trim();

						if(marca == 'Nueva'){
							$(marca_id).removeClass("label-warning");
							$(marca_id).addClass("label-info");
							$(marca_id).text('Leida');
						}
						
						$('#titulo_notificacion_encuesta').html('<h4>'+data['asunto']+' - (Recibido el '+data['fecha_creacion']+')</h4>');

						$('#contenido_notificacion_encuesta').html('<p align="justify">'+data['mensaje']+'</p>');
						
						if(data['encuesta_id'])
							$('#contenido_notificacion_encuesta').append('<br><a id="enlace_encuesta" class="btn btn-primary pull-right" target-encuesta="'+data['encuesta_id']+'" target-notificacion-usuario="'+notificacion_usuario_id+'" role="button" title="Completar Encuesta">Completar Encuesta</a>');

						$('#contenedor_notidicacion_encuesta').hide('fade');
						$('#notificacion_encuesta_contenido').show('fade');
					},
				    error: function(data){
				    	console.log("Error...");
				    	console.log(data);
				    }
				});
			});

			$(document).on('click','#enlace_encuesta',function(){
				encuesta_id = $(this).attr('target-encuesta');
				notificacion_uduario_id = $(this).attr('target-notificacion-usuario');
				$.ajax({
					method: 'GET',
					url: '{% url "consultar_encuesta" %}',
					dataType: 'json',
					data: {
						'encuesta_id': encuesta_id
					},
					success:function(data){
						console.log(data);
						$('#titulo_notificacion_encuesta').html('<h4>'+data['nombre_encuesta']+'</h4>');

						preguntas = data['preguntas'];
						total_preguntas = preguntas.length;


				    	aux = '<form id="encuesta_form">\
				    				<input type="hidden" name="csrfmiddlewaretoken" value="{{csrf_token}}">\
				    				<input name="encuesta" type="hidden" value="'+encuesta_id+'">\
			        				<input name="notificacion_usuario" type="hidden" value="'+notificacion_usuario_id+'">\
			        				<input id="total_preguntas_enc" name="total_preguntas" type="hidden" value="'+total_preguntas+'">';

			        	for(i = 0; i < total_preguntas; i++){
			        		pregunta_id = preguntas[i]['id'];
			        		aux += '<br>\
			        				<div class="row">\
			        					<div class="col-xs-12">\
			        						<input name="pregunta_'+(i + 1)+'" type="hidden" value="'+pregunta_id+'">';

			        		if(preguntas[i]['tipo_respuesta'] == 'RESP_INDEF'){
			        			aux += '<label class="text-muted">'+preguntas[i]['enunciado']+'</label>\
			        					<textarea class="form-control" rows="10" name="respuesta_indef_'+pregunta_id+'"></textarea>';
			        		}

			        		if(preguntas[i]['tipo_respuesta'] == 'RESP_DEF'){
			        			aux += '<label class="text-muted">'+preguntas[i]['enunciado']+'</label>\
			        					<div class="radio">';

			        			valores_posibles = data['valores_preguntas_definidas'][pregunta_id];
			        			for(j = 0; j < valores_posibles.length; j++){
			        				valor_id = valores_posibles[j]['id'];

			        				aux += '<div class="radio">\
			        							<label><input type="radio" name="respuesta_def_'+pregunta_id+'" value="'+valor_id+'">'+valores_posibles[j]['valor']+'</label>\
			        						</div>';
			        			}

			        			aux += '</div>';
			        		}

			        		aux += '	</div>\
			        				</div>';
			        	}

			        	aux += '	<br>\
			        				<button type="submit" class="btn btn-primary pull-right">Enviar</button>\
			        			</form>';

			        	$('#contenido_notificacion_encuesta').html(aux);
					},
				    error: function(data){
				    	console.log("Error...");
				    	console.log(data);
				    }
				});
			});

			$(document).on('click', '#cerrar_notificacion', function(){
				$('#notificacion_encuesta_contenido').hide('fade');
				$('#contenedor_notidicacion_encuesta').show('fade');
			});

			$(document).on('submit', '#encuesta_form', function(event){
				event.preventDefault();
				formData = $(this).serializeArray();
		        
		        data = {};
		        $(formData).each(function(index, obj){
		            data[obj.name] = obj.value;
		        });

		        $.ajax({
					method: 'POST',
					url: '{% url "consultar_encuesta" %}',
					dataType: 'json',
					data: data,
					success:function(data){
						console.log(data);
						notificacion_target = $('input[name="notificacion_usuario"]').val();
						$('#notificacion_'+notificacion_target).remove();

						$('#notificacion_encuesta_contenido').hide('fade');
						$('#contenedor_notidicacion_encuesta').show('fade');
					},
				    error: function(data){
				    	console.log("Error...");
				    	console.log(data);
				    }
				});
			});

			/********** FIN *************/

			/************ MODAL DE CONFIRMACIÓN DE ELIMINACIÓN DE SOLICITUD ************/
			$(document).on('click', '.eliminar-solicitud', function(){
				id_solicitud = $(this).attr('solicitud-id');
				$('#title_modal_generic').html('Confirmación');
				$('#body_modal_generic').html(
					'<div class="row text-center">\
						<div class="col-xs-12"><h4>¿Está seguro que desea eliminar esta solicitud?</h4></div>\
					</div>'
				);
				$('#footer_modal_generic').html(
					'<div class="col-xs-6">\
						<a href="#" class="btn btn-danger btn-block" data-dismiss="modal">Cancelar</a>\
					</div>\
					<div class="col-xs-6">\
						<a id="confirmar_eliminacion_solicitud" href="#" class="btn btn-primary btn-block">Aceptar</a>\
					</div>'
				);
				$('#modal_generic').modal({
					backdrop: 'static',
					keyboard: false
				});
			});
			/************ FIN **************/

			/************ ENVIAR ELIMINACIÓN DE SOLICITUD ************/
			$(document).on('click', '#confirmar_eliminacion_solicitud', function(){
				
			});
			/************ FIN **************/

		});

	</script>

{% endblock %}